<!-- batch-file-browser.component.html -->
<div class="container" *ngIf="!isLoading && batchDetails; else loadingOrError">
    <!-- <h1>File Batch</h1> -->
    <!-- <div class="batch-info">
        <p><strong>Batch Name:</strong> {{ batchDetails.batch_name }}</p>
        <p><strong>Uploaded By:</strong> {{ batchDetails.username || 'N/A' }}</p>
        <p><strong>Uploaded On:</strong> {{ formatUploadDate(batchDetails.upload_date) }}</p>
        <p><strong>Total Files:</strong> {{ batchDetails.files?.length || 0 }}</p>
        <p><strong>Total Size:</strong> {{ batchDetails.total_size | byteFormat }}</p>
    </div> -->

    <hr>

    <ul class="file-list" *ngIf="batchDetails && batchDetails.files && batchDetails.files.length > 1" ;>
        <ng-container *ngFor="let file of batchDetails.files">
            <li *ngIf="!file.skipped && !file.failed" [attr.data-filename]="file.original_filename">
                <div class="file-info">
                    <span class="file-icon">üìÑ</span>
                    <span class="file-name" [title]="file.original_filename">{{ file.original_filename }}</span>
                </div>
                <span class="file-size">{{ file.original_size | byteFormat }}</span>
                <div class="file-actions">
                    <button *ngIf="batchDetails && batchDetails.files && batchDetails.files.length > 1"
                        class="download-all-btn" (click)="initiateDownloadAll()" [disabled]="isProcessingDownload">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 5px;">
                            <path
                                d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                            <path
                                d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                        </svg>
                        Download All (.zip)
                    </button>
                </div>
            </li>
            <li *ngIf="file.skipped || file.failed" style="background-color: #fefefe; opacity: 0.6;">
                <div class="file-info">
                    <span class="file-icon" style="color: #dc3545;">‚ö†Ô∏è</span>
                    <span class="file-name" [title]="file.original_filename + ' (Failed/Skipped)'">{{
                        file.original_filename }}</span>
                </div>
                <span class="file-size">{{ file.reason || (file.failed ? 'Upload failed' : 'Skipped') }}</span>
                <div class="file-actions">
                    <button disabled>Download</button>
                </div>
            </li>
        </ng-container>
    </ul>

    <!-- MODIFIED "Download All" button -->
    <button *ngIf="batchDetails && batchDetails.files && batchDetails.files.length > 1" class="download-all-btn"
        (click)="initiateDownloadAll()" [disabled]="isProcessingDownload">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"
            style="vertical-align: text-bottom; margin-right: 5px;">
            <path
                d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
            <path
                d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
        </svg>
        Download All (.zip)
    </button>
    <!-- End of MODIFIED "Download All" button -->

    <div *ngIf="downloadStatusMessage" class="status-message" [ngClass]="{
'info': downloadStatusType === 'info',
'error': downloadStatusType === 'error',
'success': downloadStatusType === 'success'
}">
        {{ downloadStatusMessage }}
    </div>

    <h2>All File List</h2>
    <ul class="file-list" *ngIf="batchDetails.files && batchDetails.files.length > 0; else noFiles">
        <ng-container *ngFor="let file of batchDetails.files">
            <li *ngIf="!file.skipped && !file.failed" [attr.data-filename]="file.original_filename">
                <div class="main-file-name row">
                    <div class="col-2">
                        <span class="file-icon">üìÑ</span>
                    </div>
                    <div class="col-10">
                        <div class="file-info">
                            <span class="file-name" [title]="file.original_filename">{{ file.original_filename }}</span>
                        </div>
                        <div class="file-length">
                            <span>
                                <span class="file-dot">‚Ä¢</span> <span class="sharedby">Shared by</span> <span
                                    class="share-username">
                                    {{ batchDetails.username || 'N/A' }}
                                </span>
                            </span>
                            <span class="file-list-length">
                                <span class="file-dot">‚Ä¢</span> {{ batchDetails.files?.length || 0 }} File
                            </span>
                        </div>
                    </div>
                </div>
                <span class="file-size">{{ file.original_size | byteFormat }}</span>
                <div class="file-actions">
                    <button class="individual-download-button" (click)="initiateIndividualDownload(file)"
                        [disabled]="isProcessingDownload" [title]="'Download ' + file.original_filename">
                        Download
                    </button>
                </div>
            </li>
            <li *ngIf="file.skipped || file.failed" style="background-color: #fefefe; opacity: 0.6;">
                <div class="file-info">
                    <span class="file-icon" style="color: #dc3545;">‚ö†Ô∏è</span>
                    <span class="file-name" [title]="file.original_filename + ' (Failed/Skipped)'">{{
                        file.original_filename }}</span>
                </div>
                <span class="file-size">{{ file.reason || (file.failed ? 'Upload failed' : 'Skipped') }}</span>
                <div class="file-actions">
                    <button disabled>Download</button>
                </div>
            </li>
        </ng-container>
    </ul>
    <ng-template #noFiles>
        <p>No files found in this batch record.</p>
    </ng-template>
</div>

<ng-template #loadingOrError>
    <div *ngIf="isLoading" class="container text-center">Loading batch details...</div>
    <div *ngIf="error && !isLoading" class="container error-message">{{ error }}</div>
    <div *ngIf="!effectiveBatchAccessId && !isLoading && !error" class="container error-message">Batch ID missing.</div>
</ng-template>